# ============================================================
# ZecKit Sample Repo – CI
# ============================================================
#
# This workflow runs the ZecKit golden E2E shielded-transaction
# flow against two backends:
#
#   lightwalletd  – REQUIRED job.  CI fails if this fails.
#   zaino         – EXPERIMENTAL job.  Failure does not block merge;
#                   the job is still executed so signal accumulates.
#
# Backend matrix overview:
#   ┌──────────────────┬──────────────────────────────────────────┐
#   │ Backend          │ Merge-blocking?                          │
#   ├──────────────────┼──────────────────────────────────────────┤
#   │ lightwalletd     │ YES – required for CI green              │
#   │ zaino            │ NO  – experimental; result is reported   │
#   │                  │       but not enforced                   │
#   └──────────────────┴──────────────────────────────────────────┘
# ============================================================

name: ZecKit E2E CI

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: 'Artifact upload policy'
        required: false
        default: 'on-failure'
        type: choice
        options:
          - on-failure
          - always
          - never

permissions:
  contents: read
  packages: read    # needed to pull GHCR images

# ============================================================
# REQUIRED JOB – lightwalletd
# Merge is blocked if this job fails.
# ============================================================
jobs:
  e2e-lwd:
    name: "E2E (required) – lightwalletd"
    runs-on: ubuntu-latest
    timeout-minutes: 25

    # Output the action's structured results so downstream jobs
    # (or humans reading the summary) can inspect them.
    outputs:
      unified_address:       ${{ steps.zeckit.outputs.unified_address }}
      shield_txid:           ${{ steps.zeckit.outputs.shield_txid }}
      send_txid:             ${{ steps.zeckit.outputs.send_txid }}
      final_orchard_balance: ${{ steps.zeckit.outputs.final_orchard_balance }}
      block_height:          ${{ steps.zeckit.outputs.block_height }}
      test_result:           ${{ steps.zeckit.outputs.test_result }}

    steps:
      - name: Checkout sample repo
        uses: actions/checkout@v4

      # ── Core action call ───────────────────────────────────
      - name: ZecKit E2E – lightwalletd
        id: zeckit
        uses: zecdev/ZecKit@v1
        with:
          backend:                 lwd
          # lwd starts a little slower than zaino
          startup_timeout_minutes: '15'
          block_wait_seconds:      '90'
          send_amount:             '0.05'
          send_memo:               'Sample repo CI – lwd'
          upload_artifacts:        ${{ inputs.upload_artifacts || 'on-failure' }}
          ghcr_token:              ${{ secrets.GITHUB_TOKEN }}

      # ── Human-readable step summary ───────────────────────
      - name: Print results
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  lightwalletd E2E Results"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Unified Address : ${{ steps.zeckit.outputs.unified_address }}"
          echo "  Shield txid     : ${{ steps.zeckit.outputs.shield_txid }}"
          echo "  Send txid       : ${{ steps.zeckit.outputs.send_txid }}"
          echo "  Orchard balance : ${{ steps.zeckit.outputs.final_orchard_balance }} ZEC"
          echo "  Block height    : ${{ steps.zeckit.outputs.block_height }}"
          echo "  Result          : ${{ steps.zeckit.outputs.test_result }}"

  # ============================================================
  # EXPERIMENTAL JOB – zaino
  # Always executes; failure is reported but does NOT block merge.
  # ============================================================
  e2e-zaino:
    name: "E2E (experimental) – zaino"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # ── KEY FLAG: failure here is informational only ──────────
    continue-on-error: true

    outputs:
      unified_address:       ${{ steps.zeckit.outputs.unified_address }}
      shield_txid:           ${{ steps.zeckit.outputs.shield_txid }}
      send_txid:             ${{ steps.zeckit.outputs.send_txid }}
      final_orchard_balance: ${{ steps.zeckit.outputs.final_orchard_balance }}
      block_height:          ${{ steps.zeckit.outputs.block_height }}
      test_result:           ${{ steps.zeckit.outputs.test_result }}

    steps:
      - name: Checkout sample repo
        uses: actions/checkout@v4

      - name: "⚠️ Experimental – zaino backend"
        run: |
          echo "::notice::This job uses the zaino backend and is marked experimental."
          echo "::notice::A failure here does not block CI but is tracked for signal."

      - name: ZecKit E2E – zaino
        id: zeckit
        uses: zecdev/ZecKit@v1
        with:
          backend:                 zaino
          startup_timeout_minutes: '10'
          block_wait_seconds:      '75'
          send_amount:             '0.05'
          send_memo:               'Sample repo CI – zaino (experimental)'
          upload_artifacts:        ${{ inputs.upload_artifacts || 'on-failure' }}
          ghcr_token:              ${{ secrets.GITHUB_TOKEN }}

      - name: Print results
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  zaino E2E Results (experimental)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Unified Address : ${{ steps.zeckit.outputs.unified_address }}"
          echo "  Shield txid     : ${{ steps.zeckit.outputs.shield_txid }}"
          echo "  Send txid       : ${{ steps.zeckit.outputs.send_txid }}"
          echo "  Orchard balance : ${{ steps.zeckit.outputs.final_orchard_balance }} ZEC"
          echo "  Block height    : ${{ steps.zeckit.outputs.block_height }}"
          echo "  Result          : ${{ steps.zeckit.outputs.test_result }}"

  # ============================================================
  # GATE – enforces that lwd passed; surfaces zaino signal
  # ============================================================
  ci-gate:
    name: "CI Gate"
    needs: [e2e-lwd, e2e-zaino]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Evaluate results
        shell: bash
        run: |
          lwd_result="${{ needs.e2e-lwd.result }}"
          zaino_result="${{ needs.e2e-zaino.result }}"
          lwd_e2e="${{ needs.e2e-lwd.outputs.test_result }}"
          zaino_e2e="${{ needs.e2e-zaino.outputs.test_result }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  CI Gate Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "  lightwalletd  job: $lwd_result  │  e2e: $lwd_e2e"
          echo "  zaino         job: $zaino_result  │  e2e: $zaino_e2e  (experimental)"
          echo ""

          # Write GitHub step summary table
          {
            echo "## CI Gate"
            echo ""
            echo "| Backend | Job result | E2E result | Merge-blocking? |"
            echo "|---|---|---|---|"
            if [[ "$lwd_result" == "success" ]]; then
              echo "| lightwalletd | ✅ $lwd_result | $lwd_e2e | **YES** |"
            else
              echo "| lightwalletd | ❌ $lwd_result | $lwd_e2e | **YES** |"
            fi
            if [[ "$zaino_result" == "success" ]]; then
              echo "| zaino | ✅ $zaino_result | $zaino_e2e | no (experimental) |"
            else
              echo "| zaino | ⚠️ $zaino_result | $zaino_e2e | no (experimental) |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # Only fail the gate on the required job
          if [[ "$lwd_result" != "success" ]]; then
            echo "::error::Required job 'e2e-lwd' did not succeed ($lwd_result). Blocking merge."
            exit 1
          fi

          if [[ "$zaino_result" != "success" ]]; then
            echo "::warning::Experimental job 'e2e-zaino' did not succeed ($zaino_result). Not blocking merge."
          fi

          echo "✓ Gate passed – lightwalletd E2E succeeded."
