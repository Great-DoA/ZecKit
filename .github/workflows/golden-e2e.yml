# ============================================================
# ZecKit – Reusable Golden E2E Workflow
# ============================================================
# Call this workflow from any repository:
#
#   jobs:
#     zeckit-e2e:
#       uses: zecdev/ZecKit/.github/workflows/golden-e2e.yml@v1
#       with:
#         backend: zaino
#       secrets:
#         ghcr_token: ${{ secrets.GITHUB_TOKEN }}
#
# The workflow spins up a full ZecKit devnet (pre-built images),
# executes the golden shielded-transaction flow, publishes
# structured outputs, and uploads log artifacts.
# ============================================================

name: ZecKit Golden E2E (Reusable)

on:
  # Called by other workflows (same or external repos)
  workflow_call:
    inputs:
      # --- Backend ---
      backend:
        description: >
          Light-client backend: 'zaino' (Rust, faster) or 'lwd' (Lightwalletd, Go).
        type: string
        required: false
        default: 'zaino'

      # --- Timeouts ---
      startup_timeout_minutes:
        description: >
          Maximum minutes to wait for all services to become healthy.
          Zaino: ~3 min; lwd: ~4 min. Default: 10 min.
        type: number
        required: false
        default: 10

      block_wait_seconds:
        description: >
          Seconds to wait for a block after broadcasting a transaction.
          Zebra mines a block every 30-60 s. Default: 75 s.
        type: number
        required: false
        default: 75

      # --- Chain / wallet params ---
      send_amount:
        description: Amount in ZEC to send in the shielded-send step.
        type: number
        required: false
        default: 0.05

      send_address:
        description: >
          Destination Unified Address for the shielded send.
          Leave empty to perform a self-send to the faucet UA.
        type: string
        required: false
        default: ''

      send_memo:
        description: Memo text for the shielded send transaction.
        type: string
        required: false
        default: 'ZecKit E2E golden flow'

      # --- Image params ---
      image_prefix:
        description: >
          Docker image prefix (registry/owner/zeckit).
          Examples: ghcr.io/zecdev/zeckit
        type: string
        required: false
        default: 'ghcr.io/zecdev/zeckit'

      image_tag:
        description: >
          Docker image tag. Leave empty for auto-detection
          (sha-<short> → branch-name → main → latest).
        type: string
        required: false
        default: ''

      # --- Artifact behaviour ---
      upload_artifacts:
        description: >
          'always' | 'on-failure' | 'never'
          Controls when log artifacts are uploaded.
        type: string
        required: false
        default: 'on-failure'

      # --- Runner ---
      runs_on:
        description: >
          GitHub-hosted runner label for the job (e.g. ubuntu-latest,
          ubuntu-22.04, or a self-hosted label).
        type: string
        required: false
        default: 'ubuntu-latest'

    secrets:
      ghcr_token:
        description: >
          Token used to pull pre-built images from GHCR.
          Pass secrets.GITHUB_TOKEN from the calling workflow.
        required: true

    outputs:
      unified_address:
        description: Unified Address generated by the faucet wallet.
        value: ${{ jobs.golden-e2e.outputs.unified_address }}

      transparent_address:
        description: Transparent address of the faucet wallet.
        value: ${{ jobs.golden-e2e.outputs.transparent_address }}

      shield_txid:
        description: Transaction ID of the autoshield operation.
        value: ${{ jobs.golden-e2e.outputs.shield_txid }}

      send_txid:
        description: Transaction ID of the shielded send.
        value: ${{ jobs.golden-e2e.outputs.send_txid }}

      final_orchard_balance:
        description: Orchard ZEC balance after the complete E2E flow.
        value: ${{ jobs.golden-e2e.outputs.final_orchard_balance }}

      block_height:
        description: Blockchain height at end of the test.
        value: ${{ jobs.golden-e2e.outputs.block_height }}

      test_result:
        description: Overall test result – 'pass' or 'fail'.
        value: ${{ jobs.golden-e2e.outputs.test_result }}

# ============================================================
# JOBS
# ============================================================
jobs:
  golden-e2e:
    name: "Golden E2E – ${{ inputs.backend }}"
    runs-on: ${{ inputs.runs_on }}
    timeout-minutes: 30

    # ── Permissions (for GHCR pull, artifact upload, step summary) ──
    permissions:
      contents: read
      packages: read

    # ── Propagate composite-action outputs ──
    outputs:
      unified_address:       ${{ steps.run-action.outputs.unified_address }}
      transparent_address:   ${{ steps.run-action.outputs.transparent_address }}
      shield_txid:           ${{ steps.run-action.outputs.shield_txid }}
      send_txid:             ${{ steps.run-action.outputs.send_txid }}
      final_orchard_balance: ${{ steps.run-action.outputs.final_orchard_balance }}
      block_height:          ${{ steps.run-action.outputs.block_height }}
      test_result:           ${{ steps.run-action.outputs.test_result }}

    steps:
      # ── Checkout is required so the composite action can be resolved ──
      - name: Checkout ZecKit
        uses: actions/checkout@v4
        with:
          repository: zecdev/ZecKit
          # Use the same ref that triggered this workflow so that action.yml
          # and docker-compose.yml are always in sync with the workflow file.
          ref: ${{ github.ref }}

      # ── Run the composite action from the local checkout ──
      - name: Run ZecKit E2E composite action
        id: run-action
        uses: ./   # resolves to the action.yml in the ZecKit checkout above
        with:
          backend:                  ${{ inputs.backend }}
          startup_timeout_minutes:  ${{ inputs.startup_timeout_minutes }}
          block_wait_seconds:       ${{ inputs.block_wait_seconds }}
          send_amount:              ${{ inputs.send_amount }}
          send_address:             ${{ inputs.send_address }}
          send_memo:                ${{ inputs.send_memo }}
          image_prefix:             ${{ inputs.image_prefix }}
          image_tag:                ${{ inputs.image_tag }}
          upload_artifacts:         ${{ inputs.upload_artifacts }}
          ghcr_token:               ${{ secrets.ghcr_token }}
