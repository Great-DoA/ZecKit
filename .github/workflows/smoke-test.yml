name: Smoke Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read
  packages: read

jobs:
  smoke-test:
    name: Zebra Smoke Test
    runs-on: self-hosted  # Runs on your WSL runner
    env:
      IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/zeckit
    
    # Timeout after 10 minutes (devnet should be up much faster)
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Docker availability
        run: |
          docker --version
          docker compose version
      
      - name: Clean up previous runs
        run: |
          echo "Cleaning up any previous containers..."
          docker compose down -v --remove-orphans || true
          docker stop zeckit-zebra 2>/dev/null || true
          docker rm -f zeckit-zebra 2>/dev/null || true
          docker volume rm zeckit-zebra-data 2>/dev/null || true
          docker network rm zeckit-network 2>/dev/null || true
          docker system prune -f || true

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Select best prebuilt tag
        run: |
          short_sha="${GITHUB_SHA::7}"
          branch_tag="$(echo "${GITHUB_REF_NAME}" | tr '/' '-')"
          candidates=("sha-${short_sha}" "${branch_tag}" "main" "latest")

          for tag in "${candidates[@]}"; do
            if docker manifest inspect "${IMAGE_PREFIX}-zebra:${tag}" >/dev/null 2>&1; then
              echo "Using prebuilt tag: ${tag}"
              echo "ZECKIT_IMAGE_TAG=${tag}" >> "$GITHUB_ENV"
              exit 0
            fi
          done

          echo "No prebuilt tag found; will fall back to local build"
          echo "ZECKIT_IMAGE_TAG=sha-${short_sha}" >> "$GITHUB_ENV"

      - name: Pull prebuilt image
        run: |
          docker compose pull zebra || echo "Prebuilt image not found; compose will build locally."
      
      - name: Start zeckit devnet
        run: |
          echo "Starting Zebra regtest node..."
          docker compose up -d
      
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for Zebra to be ready..."
          echo "Current directory: $(pwd)"
          echo "Files in docker/healthchecks:"
          ls -la docker/healthchecks/ || echo "Directory not found"
          
          # Wait for Zebra to start
          echo "Sleeping 60 seconds for Zebra startup..."
          sleep 60
          
          # Check if Zebra is responding
          echo "Testing Zebra RPC..."
          for i in {1..12}; do
            if curl -sf --max-time 5 \
              --data-binary '{"jsonrpc":"2.0","id":"1","method":"getinfo","params":[]}' \
              -H 'content-type: application/json' \
              http://127.0.0.1:8232 > /dev/null 2>&1; then
              echo "✓ Zebra is ready!"
              break
            fi
            echo "Attempt $i/12: Zebra not ready yet, waiting..."
            sleep 10
          done
          
          echo "Health check complete"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke test suite..."
          chmod +x tests/smoke/basic-health.sh
          ./tests/smoke/basic-health.sh
      
      - name: Collect Zebra logs
        if: always()
        run: |
          echo "Collecting container logs..."
          mkdir -p logs
          docker compose logs zebra > logs/zebra.log 2>&1 || true
          docker ps -a > logs/containers.log 2>&1 || true
          docker network ls > logs/networks.log 2>&1 || true
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          echo "Tearing down devnet..."
          docker compose down -v
          
          echo "Final cleanup..."
          docker system prune -f || true
      
      - name: Test summary
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Smoke Test Execution Complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          if [ ${{ job.status }} == 'success' ]; then
            echo "✓ Status: PASSED"
          else
            echo "✗ Status: FAILED"
          fi